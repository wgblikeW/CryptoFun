from Cryptodome.Util.number import long_to_bytes
from sage.all import *


class crack_MKHL():
    def __init__(self, pbkey, cip) -> None:
        self.pbkey = pbkey
        self.cip = cip

    def implement_LLL_attack(self):
        bit_length = len(self.pbkey)
        matrix = Matrix(ZZ, bit_length+1, bit_length+1)
        for i in range(bit_length):
            matrix[i, i] = 2
            matrix[i, bit_length] = self.pbkey[i]
            matrix[bit_length, i] = 1
        matrix[bit_length, bit_length] = self.cip
        return matrix.LLL()

    def recover_msg(self):
        lattice_re = self.implement_LLL_attack()
        binary_cip = bin(self.cip)[2:]
        for i in range(len(lattice_re[:][0])):
            if (all([v in range(-1, 2) for v in lattice_re[i][0:-1]])):
                msg = ''.join(
                    ['1' if lattice_re[i][j] < 1 else '0' for j in range(len(lattice_re[i][0:-1]))])
                msg = long_to_bytes(int(msg, 2))
                return msg


if __name__ == '__main__':
    pbkey = [102970200114199166840821280, 7015, 14950, 30245, 61640, 102970200114199166840942720, 102970200114199166841067334, 102970200114199166841318517, 1001282, 2004220, 4010303, 8022975, 16046272, 32095258, 64191114, 102970200114199166969203761, 102970200114199167097590474, 102970200114199167354364015, 1027091220, 2054183268, 4108369250, 8216740179, 16433481853, 102970200114199199707785354, 65733933737, 102970200114199298308687006, 102970200114199429776555975, 102970200114199692712295845, 102970200114200218583776689, 102970200114201270326737710, 102970200114203373812659269, 8413943682625, 16827887367113, 102970200114232822615555253, 67311549473811, 102970200114333789939768603, 102970200114468413038719813, 102970200114737659236622302, 1076984791608185, 102970200116353136424037673, 4307939166439502, 8615878332879303, 102970200131430923506579403, 102970200148662680172341505, 102970200183126193503867066,
             137854053326099254, 275708106652200279, 102970200665615380145222114, 102970201217031593449627594, 2205664853217620310, 4411329706435241494, 102970208936858579711301876, 17645318825740967632, 102970235404836818322755187, 70581275302963875542, 102970341276749772768572410, 102970482439300378696328416, 102970764764401590551839117, 102971329414604014262862221, 2258600809694844089150, 102974717315818556528998062, 9034403238779376361384, 102988268920676725593542760, 103006337727154284346270381, 103042475340109401851723162, 144550451820470021809376, 289100903640940043618798, 578201807281880087238309, 104126603728762927015297668, 105283007343326687189779369, 107595814572454207538742794, 112221429030709248236670403, 18502457833020162791707262, 139975115780239492424236103, 74009831332080651166837466, 45049462549962135492856964, 193069125214123437826533506, 180197850199848541971431628, 51485100057099583420408662]
    cip = 2465277977988339506798649822
    attack_mkhl = crack_MKHL(pbkey, cip)
    print(attack_mkhl.recover_msg())
